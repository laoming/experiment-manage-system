<link rel="stylesheet" href="/ems/modules/course-list/course-list.css">

<div class="main-content" v-cloak>
    <!-- é¡µé¢é”™è¯¯æç¤º -->
    <div v-if="pageError && !loading" class="page-error">
        <div class="error-icon">âš ï¸</div>
        <h2>é¡µé¢åŠ è½½å‡ºé”™</h2>
        <p>{{ pageError }}</p>
        <button class="btn btn-primary" @click="loadData">é‡æ–°åŠ è½½</button>
    </div>

    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header" v-else>
        <h1 class="page-title">è¯¾ç¨‹ç®¡ç†</h1>
        <p class="page-subtitle">ç®¡ç†ç³»ç»Ÿè¯¾ç¨‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¯¾ç¨‹çš„åˆ›å»ºã€ç¼–è¾‘ã€æŸ¥çœ‹å’Œåˆ é™¤ã€‚ç®¡ç†è€…å¯ä»¥ç®¡ç†è¯¾ç¨‹ï¼Œä½†åªæœ‰åˆ›å»ºè€…å¯ä»¥åˆ é™¤è¯¾ç¨‹ã€‚</p>
    </div>

    <!-- æœç´¢å’Œæ“ä½œæ  -->
    <div class="toolbar" v-if="!pageError">
        <div class="search-box">
            <input
                v-model="queryForm.courseName"
                type="text"
                class="search-input"
                placeholder="è¾“å…¥è¯¾ç¨‹åç§°æœç´¢"
            >
            <button class="btn btn-primary" @click="handleSearch">
                <span>ğŸ”</span>
                <span>æœç´¢</span>
            </button>
            <button class="btn btn-secondary" @click="handleReset">
                <span>â†º</span>
                <span>é‡ç½®</span>
            </button>
        </div>
        <button class="btn btn-success" @click="openAddModal">
            <span>+</span>
            <span>æ–°å¢è¯¾ç¨‹</span>
        </button>
    </div>

    <!-- è¯¾ç¨‹åˆ—è¡¨ -->
    <div class="table-container" v-if="!pageError">
        <div v-if="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>
        <table v-else class="course-table">
            <thead>
                <tr>
                    <th>åºå·</th>
                    <th>è¯¾ç¨‹åç§°</th>
                    <th>ç®€ä»‹</th>
                    <th>åˆ›å»ºè€…</th>
                    <th>ç®¡ç†è€…</th>
                    <th>å­¦ç”Ÿäººæ•°</th>
                    <th>å®éªŒæ¨¡æ¿æ•°</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <tr v-if="courseList.length === 0">
                    <td colspan="9" class="empty-cell">
                        <div class="empty-content">
                            <div class="empty-icon">ğŸ“š</div>
                            <p>æš‚æ— æ•°æ®</p>
                        </div>
                    </td>
                </tr>
                <tr v-for="(course, index) in courseList" :key="course.id">
                    <td>{{ (pagination.current - 1) * pagination.size + index + 1 }}</td>
                    <td>{{ course.courseName }}</td>
                    <td>
                        <div class="description-preview">
                            {{ course.description || '-' }}
                        </div>
                    </td>
                    <td>{{ getCreatorName(course.creatorId) }}</td>
                    <td>
                        <span class="badge badge-admin">{{ getAdminCount(course.id) }} äºº</span>
                    </td>
                    <td>
                        <span class="badge">{{ getStudentCount(course.id) }} äºº</span>
                    </td>
                    <td>
                        <span class="badge">{{ getTemplateCount(course.id) }} ä¸ª</span>
                    </td>
                    <td>{{ formatDateTime(course.createTime) }}</td>
                    <td class="actions">
                        <button class="action-btn btn-view" @click="openViewModal(course)">
                            <span>ğŸ‘ï¸</span>
                            æŸ¥çœ‹
                        </button>
                        <button class="action-btn btn-edit" @click="openEditModal(course)">
                            <span>âœï¸</span>
                            ç¼–è¾‘
                        </button>
                        <button class="action-btn btn-bind" @click="openBindModal(course)">
                            <span>ğŸ”—</span>
                            ç»‘å®š
                        </button>
                        <button class="action-btn btn-delete" @click="handleDelete(course)">
                            <span>ğŸ—‘ï¸</span>
                            åˆ é™¤
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="pagination" v-if="courseList.length > 0 && !pageError">
        <button
            class="pagination-btn"
            :disabled="pagination.current === 1"
            @click="handlePageChange(pagination.current - 1)"
        >
            ä¸Šä¸€é¡µ
        </button>
        <span class="pagination-info">
            ç¬¬ {{ pagination.current }} / {{ pagination.pages }} é¡µ
            <span class="pagination-total">å…± {{ pagination.total }} æ¡è®°å½•</span>
        </span>
        <button
            class="pagination-btn"
            :disabled="pagination.current >= pagination.pages"
            @click="handlePageChange(pagination.current + 1)"
        >
            ä¸‹ä¸€é¡µ
        </button>
    </div>

    <!-- æ–°å¢/ç¼–è¾‘è¯¾ç¨‹å¼¹çª— -->
    <div class="modal-overlay" v-show="showFormModal && !pageError" style="display: none;" @click.self="closeFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>{{ isEditMode ? 'ç¼–è¾‘è¯¾ç¨‹' : 'æ–°å¢è¯¾ç¨‹' }}</h2>
                <button class="modal-close" @click="closeFormModal">âœ•</button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="handleSubmit">
                    <div class="form-group">
                        <label for="courseName">è¯¾ç¨‹åç§° <span class="required">*</span></label>
                        <input
                            id="courseName"
                            v-model="formData.courseName"
                            type="text"
                            class="form-control"
                            placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="description">è¯¾ç¨‹ç®€ä»‹</label>
                        <textarea
                            id="description"
                            v-model="formData.description"
                            class="form-control"
                            rows="4"
                            placeholder="è¯·è¾“å…¥è¯¾ç¨‹ç®€ä»‹"
                        ></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="closeFormModal">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-primary">
                            {{ isEditMode ? 'ä¿å­˜' : 'æ–°å¢' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹è¯¾ç¨‹å¼¹çª— -->
    <div class="modal-overlay" v-show="showViewModal && !pageError" style="display: none;" @click.self="closeViewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æŸ¥çœ‹è¯¾ç¨‹</h2>
                <button class="modal-close" @click="closeViewModal">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="view-item">
                    <label class="view-label">è¯¾ç¨‹åç§°ï¼š</label>
                    <span class="view-value">{{ currentCourse.courseName }}</span>
                </div>
                <div class="view-item">
                    <label class="view-label">åˆ›å»ºè€…ï¼š</label>
                    <span class="view-value">{{ getCreatorName(currentCourse.creatorId) }}</span>
                </div>
                <div class="view-item">
                    <label class="view-label">ç®¡ç†è€…äººæ•°ï¼š</label>
                    <span class="view-value">{{ getAdminCount(currentCourse.id) }} äºº</span>
                </div>
                <div class="view-item">
                    <label class="view-label">å­¦ç”Ÿäººæ•°ï¼š</label>
                    <span class="view-value">{{ getStudentCount(currentCourse.id) }} äºº</span>
                </div>
                <div class="view-item">
                    <label class="view-label">å®éªŒæ¨¡æ¿æ•°ï¼š</label>
                    <span class="view-value">{{ getTemplateCount(currentCourse.id) }} ä¸ª</span>
                </div>
                <div class="view-item">
                    <label class="view-label">åˆ›å»ºæ—¶é—´ï¼š</label>
                    <span class="view-value">{{ formatDateTime(currentCourse.createTime) }}</span>
                </div>
                <div class="view-item">
                    <label class="view-label">æ›´æ–°æ—¶é—´ï¼š</label>
                    <span class="view-value">{{ formatDateTime(currentCourse.updateTime) }}</span>
                </div>
                <div class="view-item">
                    <label class="view-label">è¯¾ç¨‹ç®€ä»‹ï¼š</label>
                    <p class="view-description">{{ currentCourse.description || 'æ— ' }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" @click="closeViewModal">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»‘å®šç®¡ç†å¼¹çª— -->
    <div class="modal-overlay" v-show="showBindModal && !pageError" style="display: none;" @click.self="closeBindModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>ç»‘å®šç®¡ç† - {{ currentBindCourse ? currentBindCourse.courseName : '' }}</h2>
                <button class="modal-close" @click="closeBindModal">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="bind-tabs">
                    <button
                        class="bind-tab"
                        :class="{ active: bindTab === 'admin' }"
                        @click="bindTab = 'admin'"
                    >
                        ç®¡ç†ç®¡ç†è€…
                    </button>
                    <button
                        class="bind-tab"
                        :class="{ active: bindTab === 'student' }"
                        @click="bindTab = 'student'"
                    >
                        ç®¡ç†å­¦ç”Ÿ
                    </button>
                    <button
                        class="bind-tab"
                        :class="{ active: bindTab === 'template' }"
                        @click="bindTab = 'template'"
                    >
                        ç»‘å®šå®éªŒæ¨¡æ¿
                    </button>
                </div>

                <!-- ç®¡ç†ç®¡ç†è€… -->
                <div v-if="bindTab === 'admin'" class="bind-content">
                    <div class="bind-section">
                        <h3>å¯æ·»åŠ çš„ç®¡ç†è€…</h3>
                        <div class="select-list">
                            <div
                                v-for="user in availableAdmins"
                                :key="user.id"
                                class="select-item"
                                :class="{ selected: selectedAdminIds.includes(user.id) }"
                                @click="toggleAdminSelection(user.id)"
                            >
                                <span class="checkbox" :class="{ checked: selectedAdminIds.includes(user.id) }"></span>
                                <span>{{ user.displayName }}</span>
                            </div>
                        </div>
                        <div class="bind-actions" v-if="selectedAdminIds.length > 0">
                            <button type="button" class="btn btn-success btn-sm" @click="addAdmins">
                                æ·»åŠ é€‰ä¸­ ({{ selectedAdminIds.length }})
                            </button>
                        </div>
                    </div>
                    <div class="bind-section">
                        <h3>å·²ç»‘å®šçš„ç®¡ç†è€… ({{ boundAdminIds.length }})</h3>
                        <div class="selected-list" v-if="boundAdminIds.length > 0">
                            <div
                                v-for="userId in boundAdminIds"
                                :key="userId"
                                class="selected-item"
                                :class="{ selected: selectedAdminIds.includes(userId) }"
                                @click="toggleAdminSelection(userId)"
                            >
                                <span class="checkbox" :class="{ checked: selectedAdminIds.includes(userId) }"></span>
                                <span>{{ getUserName(userId) }}</span>
                                <button class="btn-remove" @click.stop="toggleAdminSelection(userId)">âœ•</button>
                            </div>
                        </div>
                        <div v-else class="empty-text">æš‚æ— ç»‘å®šçš„ç®¡ç†è€…</div>
                        <div class="bind-actions" v-if="selectedAdminIds.length > 0">
                            <button type="button" class="btn btn-danger btn-sm" @click="removeAdmins">
                                ç§»é™¤é€‰ä¸­ ({{ selectedAdminIds.length }})
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ç®¡ç†å­¦ç”Ÿ -->
                <div v-if="bindTab === 'student'" class="bind-content">
                    <div class="bind-section">
                        <h3>å¯æ·»åŠ çš„å­¦ç”Ÿ</h3>
                        <div class="select-list">
                            <div
                                v-for="user in availableStudents"
                                :key="user.id"
                                class="select-item"
                                :class="{ selected: selectedStudentIds.includes(user.id) }"
                                @click="toggleStudentSelection(user.id)"
                            >
                                <span class="checkbox" :class="{ checked: selectedStudentIds.includes(user.id) }"></span>
                                <span>{{ user.displayName }}</span>
                            </div>
                        </div>
                        <div class="bind-actions" v-if="selectedStudentIds.length > 0">
                            <button type="button" class="btn btn-success btn-sm" @click="addStudents">
                                æ·»åŠ é€‰ä¸­ ({{ selectedStudentIds.length }})
                            </button>
                        </div>
                    </div>
                    <div class="bind-section">
                        <h3>å·²ç»‘å®šçš„å­¦ç”Ÿ ({{ boundStudentIds.length }})</h3>
                        <div class="selected-list" v-if="boundStudentIds.length > 0">
                            <div
                                v-for="userId in boundStudentIds"
                                :key="userId"
                                class="selected-item"
                                :class="{ selected: selectedStudentIds.includes(userId) }"
                                @click="toggleStudentSelection(userId)"
                            >
                                <span class="checkbox" :class="{ checked: selectedStudentIds.includes(userId) }"></span>
                                <span>{{ getUserName(userId) }}</span>
                                <button class="btn-remove" @click.stop="toggleStudentSelection(userId)">âœ•</button>
                            </div>
                        </div>
                        <div v-else class="empty-text">æš‚æ— ç»‘å®šçš„å­¦ç”Ÿ</div>
                        <div class="bind-actions" v-if="selectedStudentIds.length > 0">
                            <button type="button" class="btn btn-danger btn-sm" @click="removeStudents">
                                ç§»é™¤é€‰ä¸­ ({{ selectedStudentIds.length }})
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ç»‘å®šå®éªŒæ¨¡æ¿ -->
                <div v-if="bindTab === 'template'" class="bind-content">
                    <div class="bind-section">
                        <h3>å¯ç»‘å®šçš„å®éªŒæ¨¡æ¿</h3>
                        <div class="select-list">
                            <div
                                v-for="template in availableTemplates"
                                :key="template.id"
                                class="select-item"
                                :class="{ selected: selectedTemplateIds.includes(template.id) }"
                                @click="toggleTemplateSelection(template.id)"
                            >
                                <span class="checkbox" :class="{ checked: selectedTemplateIds.includes(template.id) }"></span>
                                <span>{{ template.templateName }}</span>
                            </div>
                        </div>
                        <div class="bind-actions" v-if="selectedTemplateIds.length > 0">
                            <button type="button" class="btn btn-success btn-sm" @click="addTemplates">
                                æ·»åŠ é€‰ä¸­ ({{ selectedTemplateIds.length }})
                            </button>
                        </div>
                    </div>
                    <div class="bind-section">
                        <h3>å·²ç»‘å®šçš„å®éªŒæ¨¡æ¿ ({{ boundTemplateIds.length }})</h3>
                        <div class="selected-list" v-if="boundTemplateIds.length > 0">
                            <div
                                v-for="templateId in boundTemplateIds"
                                :key="templateId"
                                class="selected-item"
                                :class="{ selected: selectedTemplateIds.includes(templateId) }"
                                @click="toggleTemplateSelection(templateId)"
                            >
                                <span class="checkbox" :class="{ checked: selectedTemplateIds.includes(templateId) }"></span>
                                <span>{{ getTemplateName(templateId) }}</span>
                                <button class="btn-remove" @click.stop="toggleTemplateSelection(templateId)">âœ•</button>
                            </div>
                        </div>
                        <div v-else class="empty-text">æš‚æ— ç»‘å®šçš„å®éªŒæ¨¡æ¿</div>
                        <div class="bind-actions" v-if="selectedTemplateIds.length > 0">
                            <button type="button" class="btn btn-danger btn-sm" @click="removeTemplates">
                                è§£é™¤é€‰ä¸­ ({{ selectedTemplateIds.length }})
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/ems/modules/course-list/course-list.js"></script>
